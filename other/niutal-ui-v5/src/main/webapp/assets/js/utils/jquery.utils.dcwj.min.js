//弹窗
$(document).on("click", "#create-question", function(e) {

	bootbox.dialog({
		message: $(".create-question-modal").html(),
		title: "创建问卷",
		buttons: {
			OK: {
				label: "下一步",
				className: "btn-primary",
				"callback": function() {

					var dialog = bootbox.dialog({
						className: "design-modal",
						size: "large",
						message: $(".design-question-modal").html(),
						title: "设计问卷",
						buttons: {
							OK: {
								label: "保存",
								className: "btn-primary",

							},
							Cancel: {
								label: "取消",
								className: "btn-default"
							}
						}
					});

					dialog.init(function() {

						//拖拽
						dialog.find("#list1").dragsort({
							dragSelector: "li",
							dragBetween: false,
							dragEnd: saveOrder,
							placeHolderTemplate: "<li class='placeHolder'></li>"
						});

						function saveOrder() {

						}
						//编辑问卷切换的效果
						$(".design-question-cont .title .edit-paper-icon").click(function() {
							if($(".edit-paper-wrap").is(":visible")) {
								$(this).children(".fa").removeClass("fa-pencil-square-o").addClass("fa-file-text-o");
								$(this).next(".edit-paper").text("生成问卷");
								$(this).parents(".title").next(".edit-paper-wrap").hide();
								$(".topic-choose").hide();
								$(this).parents(".design-question-cont").find(".generate-paper-wrap").removeClass("hide");
							} else {
								$(this).children(".fa").removeClass("fa-file-text-o").addClass("fa-pencil-square-o");
								$(this).next(".edit-paper").text("编辑问卷");
								$(this).parents(".title").next(".edit-paper-wrap").show();
								$(".topic-choose").toggle();
								$(this).parents(".design-question-cont").find(".generate-paper-wrap").addClass("hide");
							}
						});

						//点击移动至出现提示框
						$(".design-question-cont .operate-items .remove").popover({
							html: true,
							content: "<div class='row'><div class='col-sm-9'><input type='text' class='form-control num-input' placeholder='请输入数字'></div><div class='col-sm-3'><button type='button' class='btn btn-primary confirm-btn pull-right'>确定</button></div></div>"
						});

						//点击空白处，关闭提示框
						$(document).click(function(e) {
							var target = $(event.target); // 判断自己当前点击的内容
							if(!target.hasClass('popover') &&
								!target.hasClass('popover-content') &&
								!target.hasClass('popover-title') &&
								!target.hasClass('arrow') &&
								!target.hasClass('num-input') &&
								!target.hasClass('remove')) {
								$(".design-question-cont .operate-items .remove").popover('hide'); // 当点击body的非弹出框相关的内容的时候，关闭所有popover
							}
							$(".design-question-cont .oper ate-items .remove").click(function() {
								$(this).popover("show");
							});
						});

						$('.design-question-cont .operate-items .remove').on('shown.bs.popover', function() {
							$(".popover .popover-content .num-input").focusin(function(e) {
								e.stopPropagation();
							});
						});
						//必填和非必填的切换
						$(".design-question-cont .operate-items .dropdown-menu li a").click(function() {
							var current_val = $(this).text();
							$(this).parents(".dropdown").find("span").text(current_val);
						});
						//编辑选项的效果
						$(".design-question-cont .operate-items .edit").click(function() {
							$(this).parent(".operate-items").next().removeClass("save-status").addClass("edit-status");
							var li_length = $(this).parents(".list-item").find(".answer li").length;
							$(this).attr("disabled", "disabled")
							$(this).css("color", "#ccc");

							var num = parseInt($(this).parents(".list-item").find(".number").text());
							var ques_val = $(this).parents(".operate-items").next(".edit-status").find(".question").text();

							var title_html = $("<div class='title'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-1'><span class='question-number'>" + num + "、<span></div><div class='col-lg-9 col-md-9 col-sm-9 col-xs-9 padding-lr0'><input type='text' class='form-control' value='" + ques_val + "'></div><div class='col-lg-2 col-md-2 col-sm-2 col-xs-2 padding-lr0'><span class='single-choice'>[单选题]<i class='fa fa-plus-circle'></i></span></div></div>");
							$(this).parents(".list-item").find(".title").replaceWith(title_html);

							$(this).parents(".operate-items").next(".edit-status").find(".opt-item").each(function() {
								var option_val = $(this).text();
								var answer_html = $("<div class='col-lg-10 col-md-10 col-sm-9 col-xs-9 padding-lr0 opt-item'><input type='text' class='form-control' placeholder='选项' value='" + option_val + "'></div><div class='col-lg-1 col-md-1 col-sm-2 col-xs-2 delete-icon'><i class='fa fa-minus-circle'></i></div>");
								$(this).replaceWith(answer_html);

							})
							var note_html = $("<div class='note'><button type='button' class='btn btn-primary confirm-btn'>确定</button><span class='red'>注：点击右上角<i class='fa fa-plus-circle'></i>按钮，可在该选项后面增加一项选项。</span></div>");
							$(this).parents(".list-item").find(".answer").after(note_html);

							//删除选项
							$(".design-question-cont .edit-status .delete-icon .fa").click(function() {
								if($(this).parents(".answer").find("input").length == 2) {
									alert("不能再删除了，必须保留2个选项!");
								} else {
									$(this).parent(".delete-icon").parent("li").remove();
								}

							});
							//新增选项
							$(".design-question-cont .title .fa-plus-circle").click(function() {
								var i = $(this).parents(".title").next(".answer").find("li").length;
								var arr_opt = 'A,B,C,D,E,F,G,H'.split(',');
								var opt = arr_opt[i];
								var add_opt = $("<li class='col-lg-6 col-md-6 col-sm-6 col-xs-6'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-1 padding-lr0'><span class='option'>" + opt + "、</span></div><div class='col-lg-10 col-md-10 col-sm-9 col-xs-9 padding-lr0 opt-item'><input type='text' class='form-control' placeholder='选项'></div><div class='col-lg-1 col-md-1 col-sm-2 col-xs-2 delete-icon'><i class='fa fa-minus-circle'></i></div></li>");
								if(i < 8) {
									$(this).parents(".title").next(".answer").find("ul").append(add_opt);
								} else {
									alert("新增项已经达到上限!");
								}
								//删除新增选项
								$(".design-question-cont .edit-status .delete-icon .fa").click(function() {
									var l = $(this).parents(".answer").find("input").length
									if($(this).parents(".answer").find("input").length == 2) {
										alert("不能再删除了，必须保留2个选项!");
									} else {
										$(this).parent(".delete-icon").parent("li").remove();

									}

								});

							});
							//确定
							$(".design-question-cont .note .confirm-btn").click(function() {

								//信息不完善的情况
								$(this).parents(".edit-status").find("input").each(function() {
									if($.trim($(this).val()) == "") {
										bootbox.alert({
											className: "note-modal",
											size: "small",
											title: "提示",
											message: '请把题目信息填写完整',
											buttons: {
												ok: {
													label: '关闭',
													className: 'btn-primary'

												}
											},
											callback: function() {
												$(".note-modal").modal("hide");
											}

										});
										return false;
									}
								});
								//信息完善的情况
								var a = $(this).parents(".edit-status").find(".title input").val() != "";
								var j = $(this).parents(".edit-status").find(".answer input").length;
								for(var i = 0; i < j; i++) {
									var b = $(this).parents(".edit-status").find(".answer ul li").eq(i).find("input").val() != "";
								}

								if(a && b) {
									$(this).parents(".list-item").find(".edit").removeAttr("disabled", "disabled")
									$(this).parents(".list-item").find(".edit").css("color", "#777");
									$(this).parents(".edit-status").removeClass("edit-status").addClass("save-status");
									$(this).parent(".note").hide();

									var title_val = $(this).parents(".save-status").find(".title input").val();
									var title_info = $("<div class='title'><span class='number'>" + num + "</span>、<span class='question'>" + title_val + "</span><input type='text'>[单选题]</div>")
									$(this).parents(".save-status").find(".title").replaceWith(title_info);

									$(this).parents(".save-status").find(".delete-icon").remove();

									$(this).parents(".save-status").find("ul li input").each(function() {
										var opt_val = $(this).val();
										var answer_val = $("<div class='col-lg-11 col-md-11 col-sm-11 col-xs-11 padding-lr0 opt-item'>" + opt_val + "</div>");
										$(this).replaceWith(answer_val);

									});

								}

							});
						});

						//点击悬浮菜单，添加一行编辑题
						$(".topic-choose .topic-type ul").click(function() {
							var n = $(this).parents(".bootbox-body").find("#list1>li").length + 1;
							var cont = $("<li><div class='list-item add'><div class='operate-items'><div class='dropdown'><a class='dropdown-toggle' data-toggle='dropdown'><span>必填</span><i class='fa fa-angle-down'></i></a><ul class='dropdown-menu' role='menu' aria-labelledby='dropdownMenu1'><li role='presentation'><a role='menuitem' tabindex='-1' href='#'>必填</a></li><li role='presentation'><a role='menuitem' tabindex='-1' href='#'>不必填</a></li></ul></div><button type='button' class='edit'>编辑</button><span>删除</span><span>复制</span><button type='button' class='remove' data-container='body' data-toggle='popover' data-placement='right' data-content=''>移动至</button></div><div class='edit-status'><div class='title'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-2'><span class='question-number'>" + n + "、</span></div><div class='col-lg-9 col-md-9 col-sm-9 col-xs-8 padding-lr0'><input type='text' class='form-control'></div><div class='col-lg-2 col-md-2 col-sm-2 col-xs-2 padding-lr0'><span class='single-choice'>[单选题]<i class='fa fa-plus-circle'></i></span></div></div><div class='answer'><ul><li class='col-lg-6 col-md-6 col-sm-6 col-xs-12'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-1 padding-lr0'><span class='option'>A、</span></div><div class='col-lg-10 col-md-10 col-sm-9 col-xs-9 padding-lr0 opt-item'><input type='text' class='form-control' placeholder='选项'></div><div class='col-lg-1 col-md-1 col-sm-2 col-xs-2 delete-icon'><i class='fa fa-minus-circle'></i></div></li><li class='col-lg-6 col-md-6 col-sm-6 col-xs-12'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-1 padding-lr0'><span class='option'>B、</span></div><div class='col-lg-10 col-md-10 col-sm-9 col-xs-9 padding-lr0 opt-item'><input type='text' class='form-control' placeholder='选项'></div><div class='col-lg-1 col-md-1 col-sm-2 col-xs-2 delete-icon'><i class='fa fa-minus-circle'></i></div></li><li class='col-lg-6 col-md-6 col-sm-6 col-xs-12'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-1 padding-lr0'><span class='option'>C、</span></div><div class='col-lg-10 col-md-10 col-sm-9 col-xs-9 padding-lr0 opt-item'><input type='text' class='form-control' placeholder='选项'></div><div class='col-lg-1 col-md-1 col-sm-2 col-xs-2 delete-icon'><i class='fa fa-minus-circle'></i></div></li><li class='col-lg-6 col-md-6 col-sm-6 col-xs-12'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-1 padding-lr0'><span class='option'>D、</span></div><div class='col-lg-10 col-md-10 col-sm-9 col-xs-9 padding-lr0 opt-item'><input type='text' class='form-control' placeholder='选项'></div><div class='col-lg-1 col-md-1 col-sm-2 col-xs-2 delete-icon'><i class='fa fa-minus-circle'></i></div></li></ul></div><div class='note'><button type='button' class='btn btn-primary confirm-btn'>确定</button><span class='red'>注：点击右上角<i class='fa fa-plus-circle'></i>按钮，可在该选项后面增加一项选项。</span></div></div></div></li>");
							$(this).parents(".bootbox-body").find("#list1>li").eq(-1).after(cont);

							//点击移动至出现提示框
							$(".add .operate-items .remove").popover({
								html: true,
								content: "<div class='row'><div class='col-sm-9'><input type='text' class='form-control num-input' placeholder='请输入数字'></div><div class='col-sm-3'><button type='button' class='btn btn-primary confirm-btn pull-right'>确定</button></div></div>"
							});

							//点击空白处，关闭提示框
							$(document).click(function(event) {
								var target = $(event.target); // 判断自己当前点击的内容
								if(!target.hasClass('remove') &&
									!target.hasClass('num-input') &&
									!target.hasClass('popover') &&
									!target.hasClass('popover-content') &&
									!target.hasClass('popover-title') &&
									!target.hasClass('arrow')) {
									$(".add .operate-items .remove").popover('hide'); // 当点击body的非弹出框相关的内容的时候，关闭所有popover
								}

							});

							$('.add .operate-items .remove').on('shown.bs.popover', function() {
								$(".popover .popover-content .num-input").focusin(function(e) {
									e.stopPropagation();
								});

							});

							//删除选项
							$(".add .edit-status .delete-icon .fa").click(function() {
								if($(this).parents(".answer").find("input").length == 2) {
									alert("不能再删除了，必须保留2个选项!");
								} else {
									$(this).parent(".delete-icon").parent("li").remove();
								}
							});
							//新增选项
							$(".add .title .fa-plus-circle").click(function() {
								var i = $(this).parents(".title").next(".answer").find("li").length;
								var arr_opt = 'A,B,C,D,E,F,G,H'.split(',');
								var opt = arr_opt[i];
								var add_opt = $("<li class='col-lg-6 col-md-6 col-sm-6 col-xs-6'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-1 padding-lr0'><span class='option'>" + opt + "、</span></div><div class='col-lg-10 col-md-10 col-sm-9 col-xs-9 padding-lr0 opt-item'><input type='text' class='form-control' placeholder='选项'></div><div class='col-lg-1 col-md-1 col-sm-2 col-xs-2 delete-icon'><i class='fa fa-minus-circle'></i></div></li>");
								if(i < 8) {
									$(this).parents(".title").next(".answer").find("ul").eq(-1).append(add_opt);
								} else {
									alert("新增项已经达到上限!");
								}

								//删除新增选项
								$(".add .edit-status .delete-icon .fa").click(function() {
									if($(this).parents(".answer").find("input").length == 2) {
										alert("不能再删除了，必须保留2个选项!");
									} else {
										$(this).parent(".delete-icon").parent("li").remove();
									}

								});
							});
							//确定
							$(".add .note .confirm-btn").click(function() {
								//信息不完善的情况
								$(this).parents(".edit-status").find("input").each(function() {
									if($.trim($(this).val()) == "") {
										bootbox.alert({
											className: "note-modal",
											size: "small",
											title: "提示",
											message: '请把题目信息填写完整',
											buttons: {
												ok: {
													label: '关闭',
													className: 'btn-primary'

												}
											},
											callback: function() {
												$(".note-modal").modal("hide");
											}

										});
										return false;
									}
								});
								//信息完善的情况
								var num = parseInt($(this).parents(".list-item").find(".question-number").text());
								var a = $(this).parents(".edit-status").find(".title input").val() != "";
								var j = $(this).parents(".edit-status").find(".answer input").length;

								for(var i = 0; i < j; i++) {
									var b = $(this).parents(".edit-status").find(".answer ul li").eq(i).find("input").val() != "";
									var opt_val = $(this).parents(".edit-status").find(".answer ul li").eq(i).find("input").val();

								}
								if(a && b) {
									$(this).parents(".list-item").find(".edit").removeAttr("disabled", "disabled")
									$(this).parents(".list-item").find(".edit").css("color", "#777");
									$(this).parents(".edit-status").removeClass("edit-status").addClass("save-status");
									$(this).parent(".note").hide();

									var title_val = $(this).parents(".save-status").find(".title input").val();
									var title_info = $("<div class='title'><span class='number'>" + num + "</span>、<span class='question'>" + title_val + "</span><input type='text'>[单选题]</div>")
									$(this).parents(".save-status").find(".title").replaceWith(title_info);

									$(this).parents(".save-status").find("ul li input").each(function() {
										var opt_val = $(this).val();
										var answer_val = $("<div class='col-lg-11 col-md-11 col-sm-11 col-xs-11 padding-lr0 opt-item'>" + opt_val + "</div>");
										$(this).replaceWith(answer_val);

									});

									$(this).parents(".save-status").find(".delete-icon").remove();

								}

							});
							//编辑
							$(".add .operate-items .edit").click(function() {
								$(this).parent(".operate-items").next().removeClass("save-status").addClass("edit-status");
								var li_length = $(this).parents(".list-item").find(".answer li").length;
								$(this).attr("disabled", "disabled")
								$(this).css("color", "#ccc");

								var num = parseInt($(this).parents(".list-item").find(".number").text());
								var ques_val = $(this).parents(".operate-items").next(".edit-status").find(".question").text();

								var title_html = $("<div class='title'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-1'><span class='question-number'>" + num + "、<span></div><div class='col-lg-9 col-md-9 col-sm-9 col-xs-9 padding-lr0'><input type='text' class='form-control' value='" + ques_val + "'></div><div class='col-lg-2 col-md-2 col-sm-2 col-xs-2 padding-lr0'><span class='single-choice'>[单选题]<i class='fa fa-plus-circle'></i></span></div></div>");
								$(this).parents(".list-item").find(".title").replaceWith(title_html);

								$(this).parents(".operate-items").next(".edit-status").find(".opt-item").each(function() {
									var option_val = $(this).text();
									var answer_html = $("<div class='col-lg-10 col-md-10 col-sm-9 col-xs-9 padding-lr0 opt-item'><input type='text' class='form-control' placeholder='选项' value='" + option_val + "'></div><div class='col-lg-1 col-md-1 col-sm-2 col-xs-2 delete-icon'><i class='fa fa-minus-circle'></i></div>");
									$(this).replaceWith(answer_html);

								})

								var note_html = $("<div class='note'><button type='button' class='btn btn-primary confirm-btn'>确定</button><span class='red'>注：点击右上角<i class='fa fa-plus-circle'></i>按钮，可在该选项后面增加一项选项。</span></div>");
								$(this).parents(".list-item").find(".answer").after(note_html);
								//编辑之后的确定
								$(".add .note .confirm-btn").click(function() {
									//信息不完善的情况
									$(this).parents(".edit-status").find("input").each(function() {
										if($.trim($(this).val()) == "") {
											bootbox.alert({
												className: "note-modal",
												size: "small",
												title: "提示",
												message: '请把题目信息填写完整',
												buttons: {
													ok: {
														label: '关闭',
														className: 'btn-primary'

													}
												},
												callback: function() {
													$(".note-modal").modal("hide");
												}

											});
											return false;
										}
									});
									//信息完善的情况
									var num = parseInt($(this).parents(".list-item").find(".question-number").text());
									var a = $(this).parents(".edit-status").find(".title input").val() != "";
									var j = $(this).parents(".edit-status").find(".answer input").length;

									for(var i = 0; i < j; i++) {
										var b = $(this).parents(".edit-status").find(".answer ul li").eq(i).find("input").val() != "";
										var opt_val = $(this).parents(".edit-status").find(".answer ul li").eq(i).find("input").val();

									}
									if(a && b) {
										$(this).parents(".list-item").find(".edit").removeAttr("disabled", "disabled")
										$(this).parents(".list-item").find(".edit").css("color", "#777");
										$(this).parents(".edit-status").removeClass("edit-status").addClass("save-status");
										$(this).parent(".note").hide();

										var title_val = $(this).parents(".save-status").find(".title input").val();
										var title_info = $("<div class='title'><span class='number'>" + num + "</span>、<span class='question'>" + title_val + "</span><input type='text'>[单选题]</div>")
										$(this).parents(".save-status").find(".title").replaceWith(title_info);

										$(this).parents(".save-status").find("ul li input").each(function() {
											var opt_val = $(this).val();
											var answer_val = $("<div class='col-lg-11 col-md-11 col-sm-11 col-xs-11 padding-lr0 opt-item'>" + opt_val + "</div>");
											$(this).replaceWith(answer_val);

										});

										$(this).parents(".save-status").find(".delete-icon").remove();

									}

								});
								//编辑之后的删除选项
								$(".add .edit-status .delete-icon .fa").click(function() {
									if($(this).parents(".answer").find("input").length == 2) {
										alert("不能再删除了，必须保留2个选项!");
									} else {
										$(this).parent(".delete-icon").parent("li").remove();
									}
								});
								//编辑之后的新增选项
								$(".add .title .fa-plus-circle").click(function() {
									var i = $(this).parents(".title").next(".answer").find("li").length;
									var arr_opt = 'A,B,C,D,E,F,G,H'.split(',');
									var opt = arr_opt[i];
									var add_opt = $("<li class='col-lg-6 col-md-6 col-sm-6 col-xs-6'><div class='col-lg-1 col-md-1 col-sm-1 col-xs-1 padding-lr0'><span class='option'>" + opt + "、</span></div><div class='col-lg-10 col-md-10 col-sm-9 col-xs-9 padding-lr0 opt-item'><input type='text' class='form-control' placeholder='选项'></div><div class='col-lg-1 col-md-1 col-sm-2 col-xs-2 delete-icon'><i class='fa fa-minus-circle'></i></div></li>");
									if(i < 8) {
										$(this).parents(".title").next(".answer").find("ul").eq(-1).append(add_opt);
									} else {
										alert("新增项已经达到上限!");
									}

									//编辑之后的删除新增选项
									$(".add .edit-status .delete-icon .fa").click(function() {

										if($(this).parents(".answer").find("input").length == 2) {
											alert("不能再删除了，必须保留2个选项!");
										} else {
											$(this).parent(".delete-icon").parent("li").remove();
										}

									});
								});
							})

						});

					});

				}

			},

			Cancel: {
				label: "取消",
				className: "btn-default"
			}
		}

	});
	//选择模板
	$(".create-question-cont .choose-template a").click(function() {
		$(this).parents('.choose-template').find('a').removeClass('active');
		$(this).addClass('active');
	});

});
//文本编辑器
var editor;
KindEditor.ready(function(K) {
	editor = K.create('textarea[name="content"]', {
		resizeType: 1,
		allowPreviewEmoticons: false,
		allowImageUpload: false,
		items: [
			'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline',
			'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist',
			'insertunorderedlist', '|', 'emoticons', 'image', 'link'
		]

	});

});