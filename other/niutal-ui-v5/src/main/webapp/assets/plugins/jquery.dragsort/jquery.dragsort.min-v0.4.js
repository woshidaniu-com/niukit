// jQuery List DragSort v0.4
// Website: http://dragsort.codeplex.com/
// License: http://dragsort.codeplex.com/license
(function(b){b.fn.dragsort=function(q){var e=b.extend({},b.fn.dragsort.defaults,q),g=[],a=null,l=null;this.selector&&b("head").append("\x3cstyle type\x3d'text/css'\x3e"+(this.selector.split(",").join(" "+e.dragSelector+",")+" "+e.dragSelector)+" { cursor: pointer; }\x3c/style\x3e");this.each(function(n,k){b(k).is("table")&&1==b(k).children().size()&&b(k).children().is("tbody")&&(k=b(k).children().get(0));var p={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:k,init:function(){b(this.container).attr("data-listIdx",n).unbind("mousedown");b(this.container).attr("data-listIdx",n).mousedown(this.grabItem).find(e.dragSelector).css("cursor","pointer");b(this.container).children(e.itemSelector).each(function(a){b(this).attr("data-itemIdx",a)})},grabItem:function(d){if(1!=d.which||b(d.target).is(e.dragSelectorExclude))return!1;for(var c=d.target;!b(c).is("[data-listIdx\x3d'"+b(this).attr("data-listIdx")+"'] "+e.dragSelector);){if(c==this)return;c=c.parentNode}null!=a&&null!=a.draggedItem&&a.dropItem();b(d.target).css("cursor","move");a=g[b(this).attr("data-listIdx")];a.draggedItem=b(c).closest(e.itemSelector);var c=parseInt(a.draggedItem.css("marginTop")),f=parseInt(a.draggedItem.css("marginLeft"));a.offset=a.draggedItem.offset();a.offset.top=d.pageY-a.offset.top+(isNaN(c)?0:c)-1;a.offset.left=d.pageX-a.offset.left+(isNaN(f)?0:f)-1;e.dragBetween||(c=0==b(a.container).outerHeight()?Math.max(1,Math.round(.5+b(a.container).children(e.itemSelector).size()*a.draggedItem.outerWidth()/b(a.container).outerWidth()))*a.draggedItem.outerHeight():b(a.container).outerHeight(),a.offsetLimit=b(a.container).offset(),a.offsetLimit.right=a.offsetLimit.left+b(a.container).outerWidth()-a.draggedItem.outerWidth(),a.offsetLimit.bottom=a.offsetLimit.top+c-a.draggedItem.outerHeight());var c=a.draggedItem.height(),f=a.draggedItem.width(),h=a.draggedItem.attr("style");a.draggedItem.attr("data-origStyle",h?h:"");"tr"==e.itemSelector?(a.draggedItem.children().each(function(){b(this).width(b(this).width())}),a.placeHolderItem=a.draggedItem.clone().attr("data-placeHolder",!0),a.draggedItem.after(a.placeHolderItem),a.placeHolderItem.children().each(function(){b(this).css({borderWidth:0,width:b(this).width()+1,height:b(this).height()+1}).html("\x26nbsp;")})):(a.draggedItem.after(e.placeHolderTemplate),a.placeHolderItem=a.draggedItem.next().css({height:c,width:f}).attr("data-placeHolder",!0));a.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:c,width:f});b(g).each(function(a,b){b.createDropTargets();b.buildPositionTable()});a.scroll={moveX:0,moveY:0,maxX:b(document).width()-b(window).width(),maxY:b(document).height()-b(window).height()};a.scroll.scrollY=window.setInterval(function(){if(e.scrollContainer!=window)b(e.scrollContainer).scrollTop(b(e.scrollContainer).scrollTop()+a.scroll.moveY);else{var c=b(e.scrollContainer).scrollTop();if(0<a.scroll.moveY&&c<a.scroll.maxY||0>a.scroll.moveY&&0<c)b(e.scrollContainer).scrollTop(c+a.scroll.moveY),a.draggedItem.css("top",a.draggedItem.offset().top+a.scroll.moveY+1)}},10);a.scroll.scrollX=window.setInterval(function(){if(e.scrollContainer!=window)b(e.scrollContainer).scrollLeft(b(e.scrollContainer).scrollLeft()+a.scroll.moveX);else{var c=b(e.scrollContainer).scrollLeft();if(0<a.scroll.moveX&&c<a.scroll.maxX||0>a.scroll.moveX&&0<c)b(e.scrollContainer).scrollLeft(c+a.scroll.moveX),a.draggedItem.css("left",a.draggedItem.offset().left+a.scroll.moveX+1)}},10);a.setPos(d.pageX,d.pageY);b(document).bind("selectstart",a.stopBubble);b(document).bind("mousemove",a.swapItems);b(document).bind("mouseup",a.dropItem);e.scrollContainer!=window&&b(window).bind("DOMMouseScroll mousewheel",a.wheel);return!1},setPos:function(d,c){var f=c-this.offset.top,h=d-this.offset.left;e.dragBetween||(f=Math.min(this.offsetLimit.bottom,Math.max(f,this.offsetLimit.top)),h=Math.min(this.offsetLimit.right,Math.max(h,this.offsetLimit.left)));this.draggedItem.parents().each(function(){if("static"!=b(this).css("position")&&"table"!=b(this).css("display")){var a=b(this).offset();f-=a.top;h-=a.left;return!1}});if(e.scrollContainer==window)c-=b(window).scrollTop(),d-=b(window).scrollLeft(),c=Math.max(0,c-b(window).height()+5)+Math.min(0,c-5),d=Math.max(0,d-b(window).width()+5)+Math.min(0,d-5);else{var m=b(e.scrollContainer),g=m.offset();c=Math.max(0,c-m.height()-g.top)+Math.min(0,c-g.top);d=Math.max(0,d-m.width()-g.left)+Math.min(0,d-g.left)}a.scroll.moveX=0==d?0:d*e.scrollSpeed/Math.abs(d);a.scroll.moveY=0==c?0:c*e.scrollSpeed/Math.abs(c);this.draggedItem.css({top:f,left:h})},wheel:function(d){if((b.browser.safari||b.browser.mozilla)&&a&&e.scrollContainer!=window){var c=b(e.scrollContainer),f=c.offset();d.pageX>f.left&&d.pageX<f.left+c.width()&&d.pageY>f.top&&d.pageY<f.top+c.height()&&(f=d.detail?5*d.detail:d.wheelDelta/-2,c.scrollTop(c.scrollTop()+f),d.preventDefault())}},buildPositionTable:function(){var a=null==this.draggedItem?null:this.draggedItem.get(0),c=[];b(this.container).children(e.itemSelector).each(function(d,e){if(e!=a){var f=b(e).offset();f.right=f.left+b(e).width();f.bottom=f.top+b(e).height();f.elm=e;c.push(f)}});this.pos=c},dropItem:function(){if(null!=a.draggedItem){b(a.container).find(e.dragSelector).css("cursor","pointer");a.placeHolderItem.before(a.draggedItem);a.draggedItem.attr("style",a.draggedItem.attr("data-origStyle")).removeAttr("data-origStyle");a.placeHolderItem.remove();b("[data-dropTarget]").remove();window.clearInterval(a.scroll.scrollY);window.clearInterval(a.scroll.scrollX);var d=!1;b(g).each(function(){b(this.container).children(e.itemSelector).each(function(a){parseInt(b(this).attr("data-itemIdx"))!=a&&(d=!0,b(this).attr("data-itemIdx",a))})});d&&e.dragEnd.apply(a.draggedItem);a.draggedItem=null;b(document).unbind("selectstart",a.stopBubble);b(document).unbind("mousemove",a.swapItems);b(document).unbind("mouseup",a.dropItem);e.scrollContainer!=window&&b(window).unbind("DOMMouseScroll mousewheel",a.wheel);return!1}},stopBubble:function(){return!1},swapItems:function(d){if(null==a.draggedItem)return!1;a.setPos(d.pageX,d.pageY);for(var c=a.findPos(d.pageX,d.pageY),f=a,h=0;-1==c&&e.dragBetween&&h<g.length;h++)c=g[h].findPos(d.pageX,d.pageY),f=g[h];if(-1==c||b(f.pos[c].elm).attr("data-placeHolder"))return!1;null==l||l.top>a.draggedItem.offset().top||l.left>a.draggedItem.offset().left?b(f.pos[c].elm).before(a.placeHolderItem):b(f.pos[c].elm).after(a.placeHolderItem);b(g).each(function(a,b){b.createDropTargets();b.buildPositionTable()});l=a.draggedItem.offset();return!1},findPos:function(a,b){for(var c=0;c<this.pos.length;c++)if(this.pos[c].left<a&&this.pos[c].right>a&&this.pos[c].top<b&&this.pos[c].bottom>b)return c;return-1},createDropTargets:function(){e.dragBetween&&b(g).each(function(){var d=b(this.container).find("[data-placeHolder]"),c=b(this.container).find("[data-dropTarget]");0<d.size()&&0<c.size()?c.remove():0==d.size()&&0==c.size()&&b(this.container).append(a.placeHolderItem.clone().removeAttr("data-placeHolder").attr("data-dropTarget",!0))})}};p.init();g.push(p)});return this};b.fn.dragsort.defaults={itemSelector:"li",dragSelector:"li",dragSelectorExclude:"input, textarea, a[href], button",dragEnd:function(){},dragBetween:!1,placeHolderTemplate:"\x3cli\x3e\x26nbsp;\x3c/li\x3e",scrollContainer:window,scrollSpeed:5}})(jQuery);